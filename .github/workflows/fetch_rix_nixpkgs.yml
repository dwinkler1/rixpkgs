name: Mirror rstats-on-nix/nixpkgs to nixpkgs branch by date from rix CSV

on:
  workflow_dispatch:
    inputs:
      csv_url:
        description: "CSV URL containing a 'date' column"
        required: false
        default: "https://raw.githubusercontent.com/ropensci/rix/refs/heads/main/inst/extdata/available_df.csv"
      date_column:
        description: "CSV column name to use as upstream branch"
        required: false
        default: "date"
      pick:
        description: "Which date to pick: latest | oldest"
        required: false
        default: "latest"
      target_branch:
        description: "Branch in THIS repo that will contain the mirrored nixpkgs content"
        required: false
        default: "nixpkgs"
  schedule:
    - cron: "0 3,15 * * *"

permissions:
  contents: write

concurrency:
  group: mirror-nixpkgs
  cancel-in-progress: true

env:
  UPSTREAM_REPO: "rstats-on-nix/nixpkgs"

  # Hard defaults (schedule has no inputs)
  DEFAULT_CSV_URL: "https://raw.githubusercontent.com/ropensci/rix/refs/heads/main/inst/extdata/available_df.csv"
  DEFAULT_DATE_COLUMN: "date"
  DEFAULT_PICK: "latest"
  DEFAULT_TARGET_BRANCH: "nixpkgs"

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Resolve parameters (dispatch + schedule safe)
        id: params
        shell: bash
        run: |
          set -euo pipefail

          # Present only for workflow_dispatch. Empty for schedule.
          CSV_URL='${{ github.event.inputs.csv_url }}'
          DATE_COLUMN='${{ github.event.inputs.date_column }}'
          PICK='${{ github.event.inputs.pick }}'
          TARGET_BRANCH='${{ github.event.inputs.target_branch }}'

          if [[ -z "${CSV_URL}" ]]; then CSV_URL="${DEFAULT_CSV_URL}"; fi
          if [[ -z "${DATE_COLUMN}" ]]; then DATE_COLUMN="${DEFAULT_DATE_COLUMN}"; fi
          if [[ -z "${PICK}" ]]; then PICK="${DEFAULT_PICK}"; fi
          if [[ -z "${TARGET_BRANCH}" ]]; then TARGET_BRANCH="${DEFAULT_TARGET_BRANCH}"; fi

          PICK="$(echo "${PICK}" | tr '[:upper:]' '[:lower:]' | xargs)"
          if [[ "${PICK}" != "latest" && "${PICK}" != "oldest" ]]; then
            echo "Invalid pick='${PICK}'. Must be 'latest' or 'oldest'." >&2
            exit 1
          fi

          echo "csv_url=${CSV_URL}" >> "$GITHUB_OUTPUT"
          echo "date_column=${DATE_COLUMN}" >> "$GITHUB_OUTPUT"
          echo "pick=${PICK}" >> "$GITHUB_OUTPUT"
          echo "target_branch=${TARGET_BRANCH}" >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  csv_url=${CSV_URL}"
          echo "  date_column=${DATE_COLUMN}"
          echo "  pick=${PICK}"
          echo "  target_branch=${TARGET_BRANCH}"

      - name: Fetch CSV
        id: fetch_csv
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "${{ steps.params.outputs.csv_url }}" -o /tmp/available_df.csv
          test -s /tmp/available_df.csv
          echo "csv_path=/tmp/available_df.csv" >> "$GITHUB_OUTPUT"

      - name: Pick date (upstream branch)
        id: pick_date
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import csv, os, sys
          from datetime import date

          csv_path = os.environ["CSV_PATH"]
          col = (os.environ.get("DATE_COLUMN") or "date").strip()
          pick = (os.environ.get("PICK") or "latest").strip().lower()

          with open(csv_path, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            rows = list(reader)

          if not rows:
            print("CSV has no data rows", file=sys.stderr)
            sys.exit(1)

          headers = list(rows[0].keys())
          if col not in headers:
            print(f"Missing column '{col}' in CSV headers: {headers}", file=sys.stderr)
            sys.exit(1)

          dates = []
          for r in rows:
            v = (r.get(col) or "").strip()
            if not v:
              continue
            try:
              y, m, d = map(int, v.split("-"))
              dates.append((date(y, m, d), v))
            except Exception:
              print(f"Invalid date value '{v}' (expected YYYY-MM-DD)", file=sys.stderr)
              sys.exit(1)

          if not dates:
            print(f"No valid dates found in column '{col}'", file=sys.stderr)
            sys.exit(1)

          chosen = min(dates)[1] if pick == "oldest" else max(dates)[1]

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"branch_date={chosen}\n")
          print(f"Selected upstream branch: {chosen}")
          PY
        env:
          CSV_PATH: ${{ steps.fetch_csv.outputs.csv_path }}
          DATE_COLUMN: ${{ steps.params.outputs.date_column }}
          PICK: ${{ steps.params.outputs.pick }}

      - name: Checkout upstream repo at that date branch
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.pick_date.outputs.branch_date }}
          path: upstream
          fetch-depth: 1

      - name: Switch to target branch in this repo (create/reset)
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ steps.params.outputs.target_branch }}"

          # Ensure we know about remote branches
          git fetch origin "+refs/heads/*:refs/remotes/origin/*"

          # Create local target branch (or reset it to remote if it exists)
          if git show-ref --verify --quiet "refs/remotes/origin/$TARGET"; then
            git checkout -B "$TARGET" "origin/$TARGET"
          else
            git checkout -B "$TARGET"
          fi

      - name: Replace target branch root with upstream snapshot (exclude workflows)
        shell: bash
        run: |
          set -euo pipefail

          STAGE="$(mktemp -d)"

          # Stage upstream into temp dir, excluding .github/workflows
          rsync -a --exclude ".git" --exclude ".github/workflows/**" upstream/ "$STAGE/"

          # Wipe working tree except .git
          find . -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy staged snapshot into repo root
          cp -a "$STAGE/." .
          rm -rf "$STAGE"

          echo "Upstream branch date: ${{ steps.pick_date.outputs.branch_date }}" > .vendored-from
          echo "Repo: ${{ env.UPSTREAM_REPO }}" >> .vendored-from
          echo "Excluded: .github/workflows/**" >> .vendored-from

      - name: Commit and push to target branch (force)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          BR="${{ steps.pick_date.outputs.branch_date }}"
          TARGET="${{ steps.params.outputs.target_branch }}"

          git commit -m "Mirror ${{ env.UPSTREAM_REPO }} branch ${BR}"
          git push --force-with-lease origin "HEAD:$TARGET"
