name: Mirror rstats-on-nix/nixpkgs to nixpkgs branch by date from rix CSV

on:
  workflow_dispatch:
    inputs:
      csv_url:
        description: "CSV URL containing a 'date' column"
        required: false
        default: "https://raw.githubusercontent.com/ropensci/rix/refs/heads/main/inst/extdata/available_df.csv"
      date_column:
        description: "CSV column name to use as upstream branch"
        required: false
        default: "date"
      pick:
        description: "Which date to pick: latest | oldest"
        required: false
        default: "latest"
      target_branch:
        description: "Branch in THIS repo that will contain the mirrored nixpkgs content"
        required: false
        default: "nixpkgs"
  schedule:
    - cron: "0 3,15 * * *"

permissions:
  contents: write

concurrency:
  group: mirror-nixpkgs
  cancel-in-progress: true

env:
  UPSTREAM_REPO: "rstats-on-nix/nixpkgs"

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch CSV
        id: fetch_csv
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "${{ inputs.csv_url }}" -o /tmp/available_df.csv
          echo "csv_path=/tmp/available_df.csv" >> "$GITHUB_OUTPUT"

      - name: Pick date (upstream branch)
        id: pick_date
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import csv, os, sys
          from datetime import date

          csv_path = os.environ["CSV_PATH"]
          col = os.environ.get("DATE_COLUMN", "date")
          pick = os.environ.get("PICK", "latest").strip().lower()

          with open(csv_path, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            rows = list(reader)

          if not rows:
            print("CSV has no data rows", file=sys.stderr)
            sys.exit(1)

          if col not in rows[0]:
            print(f"Missing column '{col}' in CSV headers: {list(rows[0].keys())}", file=sys.stderr)
            sys.exit(1)

          dates = []
          for r in rows:
            v = (r.get(col) or "").strip()
            if not v:
              continue
            try:
              y, m, d = map(int, v.split("-"))
              dates.append((date(y, m, d), v))
            except Exception:
              print(f"Invalid date value '{v}' (expected YYYY-MM-DD)", file=sys.stderr)
              sys.exit(1)

          if not dates:
            print(f"No valid dates found in column '{col}'", file=sys.stderr)
            sys.exit(1)

          chosen = min(dates)[1] if pick == "oldest" else max(dates)[1]

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"branch_date={chosen}\n")
          print(f"Selected upstream branch: {chosen}")
          PY
        env:
          CSV_PATH: ${{ steps.fetch_csv.outputs.csv_path }}
          DATE_COLUMN: ${{ inputs.date_column }}
          PICK: ${{ inputs.pick }}

      - name: Checkout upstream repo at that date branch
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.pick_date.outputs.branch_date }}
          path: upstream
          fetch-depth: 1

      - name: Switch to target branch in this repo (create/reset)
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ inputs.target_branch }}"
          if [ -z "${TARGET:-}" ]; then TARGET="nixpkgs"; fi

          # Ensure we know about remote branches
          git fetch origin "+refs/heads/*:refs/remotes/origin/*"

          # Create local target branch (or reset it to remote if it exists)
          if git show-ref --verify --quiet "refs/remotes/origin/$TARGET"; then
            git checkout -B "$TARGET" "origin/$TARGET"
          else
            git checkout -B "$TARGET"
          fi

      - name: Replace target branch root with upstream snapshot (no rsync vanish)
        shell: bash
        run: |
          set -euo pipefail

          # Stage upstream into a temp dir outside the git working tree
          STAGE="$(mktemp -d)"
          cp -a upstream/. "$STAGE/"
          rm -rf "$STAGE/.git" || true

          # Wipe working tree except .git (and remove upstream too)
          find . -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy staged snapshot into repo root
          cp -a "$STAGE/." .
          rm -rf "$STAGE"

          echo "Upstream branch date: ${{ steps.pick_date.outputs.branch_date }}" > .vendored-from
          echo "Repo: ${{ env.UPSTREAM_REPO }}" >> .vendored-from

      - name: Commit and push to target branch (force)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          BR="${{ steps.pick_date.outputs.branch_date }}"
          TARGET="${{ inputs.target_branch }}"
          if [ -z "${TARGET:-}" ]; then TARGET="nixpkgs"; fi

          git commit -m "Mirror ${{ env.UPSTREAM_REPO }} branch ${BR}"
          git push --force-with-lease origin "HEAD:$TARGET"
